pcall(function()
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local UserInputService = game:GetService("UserInputService")
    local StarterGui = game:GetService("StarterGui")
    local RunService = game:GetService("RunService")

    local LocalPlayer = Players.LocalPlayer
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local Humanoid = Character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then return end

    local RemotesFolder = ReplicatedStorage:WaitForChild("Remotes")
    local ChangeBodyColorRemote = RemotesFolder:FindFirstChild("ChangeBodyColor")
    local ChangeCharacterBodyRemote = RemotesFolder:FindFirstChild("ChangeCharacterBody")
    local WearRemote = RemotesFolder:WaitForChild("Wear")
    local WearShirtRemote = RemotesFolder:WaitForChild("WearShirt")
    local WearPantsRemote = RemotesFolder:WaitForChild("WearPants")
    local RemoteSound = ReplicatedStorage:FindFirstChild("RE") and ReplicatedStorage.RE:FindFirstChild("1Gu1nSound1s")

    -- Sistema de Bug Player
    local buggedPlayers = {}
    local bugConnections = {}

    local function bugPlayer(targetPlayer)
        local Remote = ReplicatedStorage:FindFirstChild("RE") and ReplicatedStorage.RE:FindFirstChild("1Gu1n")
        if not Remote then return end
        if not targetPlayer or not targetPlayer.Character then return end
        
        local playerName = targetPlayer.Name
        if buggedPlayers[playerName] then
            -- SE JÁ ESTÁ BUGADO: DESBUGA
            if bugConnections[playerName] then
                bugConnections[playerName]:Disconnect()
                bugConnections[playerName] = nil
            end
            buggedPlayers[playerName] = nil
            return false
        end
        
        -- SE NÃO ESTÁ BUGADO: BUGA
        buggedPlayers[playerName] = true
        bugConnections[playerName] = RunService.Stepped:Connect(function()
            local target = Players:FindFirstChild(playerName)
            if not target or not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then
                if bugConnections[playerName] then
                    bugConnections[playerName]:Disconnect()
                    bugConnections[playerName] = nil
                end
                buggedPlayers[playerName] = nil
                return
            end
            
            local crazyVector = Vector3.new(
                math.random(1e10000, 1e10000),
                math.random(1e10000, 1e10000),
                math.random(1e10000, 1e10000)
            )
            
            local args = {
                [1] = target.Character.HumanoidRootPart,
                [2] = target.Character.HumanoidRootPart,
                [3] = crazyVector,
                [4] = target.Character.HumanoidRootPart.Position,
                [5] = LocalPlayer.Backpack:FindFirstChild("Assault") and LocalPlayer.Backpack.Assault.GunScript_Local:FindFirstChild("MuzzleEffect"),
                [6] = LocalPlayer.Backpack:FindFirstChild("Assault") and LocalPlayer.Backpack.Assault.GunScript_Local:FindFirstChild("HitEffect"),
                [7] = 3000,
                [8] = 3000,
                [9] = { [1] = false },
                [10] = {
                    [1] = 10000,
                    [2] = Vector3.new(3000, 3000, 3000),
                    [3] = BrickColor.new(29),
                    [4] = 0.05,
                    [5] = Enum.Material.SmoothPlastic,
                    [6] = 0.05
                },
                [11] = true,
                [12] = false
            }
            
            Remote:FireServer(unpack(args))
        end)
        return true
    end

    local function getPlayerFromMouse(mouse)
        local target = mouse.Target
        if not target then return nil end
        local character = target.Parent
        while character and not character:FindFirstChild("Humanoid") do
            character = character.Parent
        end
        if character and character:FindFirstChild("Humanoid") then
            return Players:GetPlayerFromCharacter(character)
        end
        return nil
    end

    if ChangeBodyColorRemote then
        pcall(function() ChangeBodyColorRemote:FireServer("Lime green") end)
    end

    if ChangeCharacterBodyRemote then
        pcall(function()
            local args = {
                [1] = {
                    [1] = 123968377411056,
                    [2] = 104281326156987,  
                    [3] = 94645302037763,  
                    [4] = 84431523780379,  
                    [5] = 89124612345294,  
                    [6] = 0
                }
            }
            ChangeCharacterBodyRemote:InvokeServer(unpack(args))
        end)
    end

    local ok, desc = pcall(function() return Humanoid:GetAppliedDescription() end)
    if ok and desc then
        for _, accessory in ipairs(desc:GetAccessories(true)) do
            if accessory.AssetId then
                pcall(function() WearRemote:InvokeServer(accessory.AssetId) end)
            end
        end
    end

    local accessoriesToWear = {138469192396526, 136658063467207}
    for _, id in ipairs(accessoriesToWear) do
        pcall(function() WearRemote:InvokeServer(id) end)
    end

    local shirtsToWear = {9683332649}
    local pantsToWear = {730003802}
    for _, id in ipairs(shirtsToWear) do pcall(function() WearShirtRemote:InvokeServer(id) end) end
    for _, id in ipairs(pantsToWear) do pcall(function() WearPantsRemote:InvokeServer(id) end) end

    local tool = Instance.new("Tool")
    tool.Name = "1x1x1x1"
    tool.RequiresHandle = false
    tool.CanBeDropped = false
    tool.TextureId = "rbxassetid://114841792124711"
    tool.Parent = LocalPlayer:WaitForChild("Backpack")

    local equipped = false
    local active = {}
    local animationPool = {
        139879794862714,
        139707883040856
    }
    math.randomseed(tick() + (LocalPlayer.UserId or 0))

    local function stopActiveAnimations()
        for id, track in pairs(active) do
            pcall(function()
                if track.IsPlaying then track:Stop() end
                track:Destroy()
            end)
            active[id] = nil
        end
    end

    local function playEmote()
        pcall(function()
            stopActiveAnimations()
            local animId = animationPool[math.random(1, #animationPool)]
            if typeof(Humanoid.PlayEmoteAndGetAnimTrackById) == "function" then
                local track = Humanoid:PlayEmoteAndGetAnimTrackById(animId)
                if track then
                    track.Looped = true
                    track.Priority = Enum.AnimationPriority.Action
                    active[animId] = track
                    track.Stopped:Connect(function() active[animId] = nil end)
                    return
                end
            end

            local anim = Instance.new("Animation")
            anim.AnimationId = "rbxassetid://"..tostring(animId)
            local track = Humanoid:LoadAnimation(anim)
            track.Looped = true
            track.Priority = Enum.AnimationPriority.Action
            track:Play()
            active[animId] = track
            track.Stopped:Connect(function() active[animId] = nil end)
        end)
    end

    local soundIds = {
        132686709305301, 
        111264583736529, 
        83476292396738,
        139477985881551,
        132245317457036
    }
    local soundIndex = 1
    local volume = 0.95

    local function playLocalSound(parent, id)
        pcall(function()
            local sound = Instance.new("Sound")
            sound.SoundId = "rbxassetid://"..tostring(id)
            sound.Volume = volume
            sound.Parent = parent
            sound:Play()
            sound.Ended:Connect(function() sound:Destroy() end)
        end)
    end

    local mouse

    tool.Equipped:Connect(function(mouseInput)
        equipped = true
        mouse = mouseInput
        
        -- Conectar clique do mouse para animação + bug
        if mouse then
            mouse.Button1Down:Connect(function()
                -- Tocar animação e som SEMPRE
                playEmote()

                local currentId = soundIds[soundIndex]

                if RemoteSound then
                    pcall(function()
                        RemoteSound:FireServer(Character:FindFirstChild("HumanoidRootPart"), currentId, volume)
                    end)
                end

                playLocalSound(Character:FindFirstChild("HumanoidRootPart") or Character.PrimaryPart or Character, currentId)

                soundIndex = (soundIndex % #soundIds) + 1
                
                -- Verificar se clicou em um jogador para bugar também
                local targetPlayer = getPlayerFromMouse(mouse)
                if targetPlayer and targetPlayer ~= LocalPlayer then
                    local wasBugged = buggedPlayers[targetPlayer.Name]
                    local isNowBugged = bugPlayer(targetPlayer)
                    
                    -- Notificação de qual jogador foi bugado/desbugado
                    if isNowBugged then
                        StarterGui:SetCore("SendNotification", {
                            Title = "1x1x1x1",
                            Text = "Bugando: " .. targetPlayer.Name,
                            Duration = 3
                        })
                    else
                        StarterGui:SetCore("SendNotification", {
                            Title = "1x1x1x1",
                            Text = "Desbugado: " .. targetPlayer.Name,
                            Duration = 3
                        })
                    end
                end
            end)
        end
    end)

    tool.Unequipped:Connect(function()
        equipped = false
        mouse = nil
    end)

    UserInputService.InputBegan:Connect(function(input, gpe)
        if not equipped or gpe then return end
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            -- Já está sendo tratado no tool.Equipped
        end
    end)

    local animate = Character:WaitForChild("Animate")
    for _, track in ipairs(Humanoid:GetPlayingAnimationTracks()) do
        pcall(function() track:Stop(); track:Destroy() end)
    end

    pcall(function()
        animate.walk.WalkAnim.AnimationId   = "http://www.roblox.com/asset/?id=121350640829746"
        animate.run.RunAnim.AnimationId     = "http://www.roblox.com/asset/?id=121350640829746"
        animate.idle.Animation1.AnimationId = "http://www.roblox.com/asset/?id=135425213693488"
        animate.idle.Animation2.AnimationId = "http://www.roblox.com/asset/?id=135579638960045"
        animate.jump.JumpAnim.AnimationId   = "http://www.roblox.com/asset/?id=104108770420406"
        animate.fall.FallAnim.AnimationId   = "http://www.roblox.com/asset/?id=104108770420406"
        animate.climb.ClimbAnim.AnimationId = "http://www.roblox.com/asset/?id=421121499"
    end)

    Humanoid.Jump = false

    -- Comandos do chat para controle do bug
    LocalPlayer.Chatted:Connect(function(message)
        local msg = message:lower()
        if msg == "/stopallbugs" then
            for _, connection in pairs(bugConnections) do
                if connection then connection:Disconnect() end
            end
            bugConnections = {}
            buggedPlayers = {}
            StarterGui:SetCore("SendNotification", {
                Title = "Bug System",
                Text = "Todos os bugs foram parados",
                Duration = 3
            })
        elseif msg == "/buggedlist" then
            local count = 0
            local names = ""
            for name in pairs(buggedPlayers) do 
                count = count + 1 
                if names == "" then
                    names = name
                else
                    names = names .. ", " .. name
                end
            end
            StarterGui:SetCore("SendNotification", {
                Title = "Bug System",
                Text = "Jogadores bugados: " .. count .. "\n" .. (names == "" and "Nenhum" or names),
                Duration = 5
            })
        elseif msg:sub(1, 5) == "/bug " then
            local targetName = msg:sub(6)
            local targetPlayer = Players:FindFirstChild(targetName)
            if targetPlayer then
                local isNowBugged = bugPlayer(targetPlayer)
                StarterGui:SetCore("SendNotification", {
                    Title = "Bug System",
                    Text = isNowBugged and "Bugando: " .. targetName or "Já estava bugado: " .. targetName,
                    Duration = 3
                })
            else
                StarterGui:SetCore("SendNotification", {
                    Title = "Bug System",
                    Text = "Jogador não encontrado: " .. targetName,
                    Duration = 3
                })
            end
        elseif msg:sub(1, 7) == "/unbug " then
            local targetName = msg:sub(8)
            local targetPlayer = Players:FindFirstChild(targetName)
            if targetPlayer and buggedPlayers[targetName] then
                if bugConnections[targetName] then
                    bugConnections[targetName]:Disconnect()
                    bugConnections[targetName] = nil
                end
                buggedPlayers[targetName] = nil
                StarterGui:SetCore("SendNotification", {
                    Title = "Bug System",
                    Text = "Desbugado: " .. targetName,
                    Duration = 3
                })
            else
                StarterGui:SetCore("SendNotification", {
                    Title = "Bug System",
                    Text = "Jogador não está bugado: " .. targetName,
                    Duration = 3
                })
            end
        end
    end)

    -- Limpar quando jogador sair
    Players.PlayerRemoving:Connect(function(leavingPlayer)
        local playerName = leavingPlayer.Name
        if bugConnections[playerName] then
            bugConnections[playerName]:Disconnect()
            bugConnections[playerName] = nil
        end
        if buggedPlayers[playerName] then
            buggedPlayers[playerName] = nil
        end
    end)

    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "1x1x1x1",
            Text = "By Rick",
            Icon = "rbxassetid://114841792124711",
            Duration = 10,
            Button1 = "OK"
        })
    end)
end)
